stages:
  - deploy

variables:
  DEPLOYMENT_ROOT: 'C:/Deployment'
  ErrorActionPreference: STOP

.deploy_env:
  stage: deploy
  script:
    - $env:path
    - echo 'Deploying to Test'
    - echo 'Creating folder for Test'
    - New-Item -Path $env:DEPLOYMENT_ROOT -Name $env:envname -ItemType "directory" -Force
    - echo 'Copying files to deployment folder'
    - $target = Join-Path $env:DEPLOYMENT_ROOT $env:envname
    - $source = Join-Path $env:CI_PROJECT_DIR "*" 
    - Copy-Item $source -Destination $target -Recurse -Container -Force
    - echo "Files copied to $target"

deploy_test:
  extends: .deploy_env
  stage: deploy
  environment:
    name: Test
  variables:
    envname: 'test'
  only:
    - test
  tags:
    - test

deploy_acc:
  extends: .deploy_env
  stage: deploy
  environment:
    name: Acc
  variables:
    envname: 'acc'
  only:
    - acc
  tags:
    - acc

deploy_prod:
  extends: .deploy_env
  stage: deploy
  environment:
    name: Prod
  variables:
    envname: 'prod'
  only:
    - prod
  tags:
    - prod